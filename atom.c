#include "atom.h"
#include <assert.h>
#include <limits.h>
#include <stdlib.h>
#include <string.h>

#define NELEMS(x) ((sizeof(x)) / (sizeof(x[0])))

static struct atom {
    struct atom* link;
    int len;
    char* str;
} * buckets[2048];

const static unsigned long scatter[] = {
    101579958  , 3211693773 , 1967294712 , 4243619406 , 859341807  , 956118737  , 3612832883 , 377306971  , 1963223274 , 1737103122 , 3551541774 , 1194314865 , 1188410577 , 44716357   , 984131330  , 2461425425 , 2457562567 ,
    3412101024 , 1568978433 , 2440268787 , 2696076856 , 2939639763 , 413021860  , 715827873  , 1131399012 , 548419144  , 481730067  , 2464219988 , 1101523753 , 3016111517 , 2167201013 , 2268213006 , 56797457   , 4232357473 ,
    2346112666 , 3378046455 , 2127366811 , 2847013646 , 3141502310 , 3643541500 , 1628519117 , 3717106759 , 403212416  , 4098816934 , 2142409977 , 3467057490 , 3207567035 , 1389801271 , 2116888270 , 2705055960 , 2834887364 ,
    2611103755 , 3231277475 , 2243640795 , 3124530316 , 2854743084 , 2434017023 , 231740663  , 316136440  , 2239054390 , 2460634219 , 3531947484 , 2399400135 , 2602869613 , 1703432827 , 1228641547 , 2706305987 , 1057319963 ,
    2586733338 , 3778363855 , 1392112938 , 1681458735 , 3630693141 , 1635007615 , 2507834462 , 2592320019 , 1321685739 , 2142032113 , 3454061772 , 1217438157 , 1550166738 , 3289180481 , 2699088921 , 736885337  , 2108071436 ,
    2660658371 , 4248884627 , 258879301  , 2009080171 , 3335393093 , 1802143446 , 3420306573 , 3334877474 , 3565030537 , 2497769917 , 2189656759 , 1174045134 , 525143042  , 274366347  , 393451826  , 505430212  , 3672684749 ,
    1983783257 , 4048153323 , 4086570908 , 1803860465 , 2688926146 , 4028320049 , 1290229501 , 242022107  , 1023642573 , 2925121739 , 1136684202 , 2876052499 , 2634793754 , 4201512278 , 1857943756 , 4090131523 , 3095574864 ,
    2445473507 , 220149377  , 3247663466 , 2127445190 , 503838160  , 1961835430 , 2919363164 , 1714121839 , 1952733414 , 3128210400 , 4122099837 , 820563211  , 174119347  , 2728794864 , 2322444734 , 4244872075 , 3057916713 ,
    3378582072 , 1967745751 , 2464790724 , 2913169016 , 270937480  , 1943612870 , 3877603927 , 3152521768 , 1276699437 , 3459635335 , 4136197343 , 3196444537 , 721623867  , 2090387476 , 3256460124 , 1756092926 , 1763506713 ,
    1984555935 , 2778882015 , 891381112  , 878232142  , 1537385486 , 3733635446 , 2837222895 , 3706874251 , 1155857334 , 1495888730 , 3469393431 , 3187891448 , 3919958620 , 3229735254 , 3981250529 , 1926914242 , 4102814056 ,
    3274040698 , 2347340639 , 852973284  , 2770517099 , 2751206145 , 2788147164 , 2374674740 , 2793456083 , 94962302   , 835785531  , 1306092209 , 813891564  , 4099740493 , 3438166928 , 2783237131 , 1583010330 , 918971961  ,
    3365377788 , 2658561907 , 3492907605 , 3555100009 , 1514257869 , 3283031973 , 2224982756 , 3817602448 , 502180565  , 196841010  , 4038227037 , 2536526932 , 3452585482 , 105622801  , 1666560988 , 2331629566 , 1106982238 ,
    1267619688 , 2629520770 , 1235280995 , 2842126304 , 544288151  , 2879876913 , 553273617  , 153960212  , 1810124934 , 139102085  , 652516542  , 4136616590 , 3638710319 , 4050640149 , 2321156588 , 2400717269 , 1274777965 ,
    146805226  , 526790881  , 3181992054 , 2284209926 , 752389951  , 650107590  , 2907326566 , 546454007  , 2532652411 , 1522973212 , 2388745884 , 2655014143 , 955272299  , 1101329511 , 2267399662 , 4062091118 , 1364479939 ,
    2975158549 , 4211362860 , 493347630  , 1413682135 , 2689378736 , 12037499   , 487033361  , 4226866837 , 797415236  , 483772915  , 465632860  , 2792509638 , 4189886737 , 1099968890 , 3537623700 , 4188007301 , 2557558900 ,
    191418850
};

int Atom_length(const char* str)
{
    struct atom* p;
    int i;

    assert(str);
    for (i = 0; i < NELEMS(buckets); i++) {
        for (p = buckets[i]; p; p = p->link) {
            if (p->str == str)
                return p->len;
        }
    }

    assert(0);
    return 0;
}

const char* Atom_new(const char* str, int len)
{
    unsigned long h;
    int i;
    struct atom* p;

    assert(str);
    assert(len >= 0);

    for (h = 0, i = 0; i < len; i++)
        h = (h << 1) + scatter[(unsigned char)str[i]];
    h %= NELEMS(buckets);

    for (p = buckets[h]; p; p = p->link) {
        if (len == p->len) {
            for (i = 0; i < len && p->str[i] == str[i];)
                i++;
            if (i = len)
                return p->str;
        }
    }

    p = (struct atom*)malloc(sizeof(*p) + len + 1);
    p->len = len;
    p->str = (char*)(p + 1);
    if (len > 0)
        memcpy(p->str, str, len);
	p->str[len] = '\0';
    p->link = buckets[h];
    buckets[h] = p;

    return p->str;
}

const char* Atom_string(const char* str)
{
    assert(str);
    return Atom_new(str, strlen(str));
}

const char* Atom_int(long n)
{
    char str[43];
    char* s = str + sizeof(str);
    unsigned long m;

    if (n == LONG_MIN)
        m = LONG_MAX + 1UL;
    else if (n < 0)
        m = -n;
    else
        m = n;

    do
        *--s = m % 10 + '0';
    while ((m /= 10) > 0);

    if (n < 0)
        *--s = '-';
    return Atom_new(s, (str + sizeof(str)) - s);
}
